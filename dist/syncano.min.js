/*! syncano 31-03-2014 */
!function(a,b){"use strict";function c(a){var b={},c="Boolean Number String Function Array Date RegExp Object".split(" ");for(var d in c)b["[object "+c[d]+"]"]=c[d].toLowerCase();return null===a?String(a):b[Object.prototype.toString.call(a)]||"object"}function d(a){return"function"===c(a)}function e(a){return null!==a&&a==a.window}function f(a){var d=Object.prototype.hasOwnProperty;if(!a||"object"!==c(a)||a.nodeType||e(a))return!1;try{if(a.constructor&&!d.call(a,"constructor")&&!d.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(f){return!1}var g;for(g in a);return g===b||d.call(a,g)}function g(a){return"array"===c(a)}function h(){var a,c,e,i,j,k,l=arguments[0]||{},m=1,n=arguments.length,o=!1;for("boolean"==typeof l&&(o=l,l=arguments[1]||{},m=2),"object"==typeof l||d(l)||(l={});n>m;m++)if(null!==(a=arguments[m]))for(c in a)e=l[c],i=a[c],l!==i&&(o&&i&&(f(i)||(j=g(i)))?(j?(j=!1,k=e&&g(e)?e:[]):k=e&&f(e)?e:{},l[c]=h(o,k,i)):i!==b&&(l[c]=i));return l}var i={},j={},k=0;i.on=function(a,b){if("function"!=typeof b)return!1;j.hasOwnProperty(a)||(j[a]={});var c="uid_"+ ++k;return j[a][c]=b,c},i.hasSubscribers=function(a){return"string"!=typeof a?!1:j.hasOwnProperty(a)&&Object.keys(j[a]).length?!0:!1},i.off=function(a,b){if(!this.hasSubscribers(a))return!1;if("undefined"==typeof b)return delete j[a];var c=j[a];for(var d in c)if(c.hasOwnProperty(d)&&b===c[d])return delete j[a][d];return!1},i.trigger=function(a){return i.doTrigger(a,!1,Array.prototype.slice.call(arguments,1))},i.triggerSync=function(a){return i.doTrigger(a,!0,Array.prototype.slice.call(arguments,1))},i.doTrigger=function(a,b){var c,d,e,f=!1,g=Array.prototype.slice.call(arguments,2)[0];if(this.hasSubscribers(a)){c=j[a];for(d in c)c.hasOwnProperty(d)&&(e=c[d],b===!1?setTimeout(e.call(e,g),0):e.call(e,g),f=!0)}var h="all";if(this.hasSubscribers(h)){c=j[h];for(d in c)c.hasOwnProperty(d)&&(e=c[d],b===!1?setTimeout(e.call(e,a,g),0):e.call(e,a,g),f=!0)}return f};var l={};l.new=function(a,b,c){var d="project.new";this.__super__.sendRequest(d,{name:a,description:b},function(a){var b=a.project;"function"==typeof c&&c(b)})},l.get=function(a){var b="project.get";this.__super__.sendRequest(b,{},function(b){var c=b.project;"function"==typeof a&&a(c)})},l.getOne=function(a,b){this.__super__.__checkProjectId(a);var c="project.get_one";this.__super__.sendRequest(c,{id:a},function(a){var c=a.project;"function"==typeof b&&b(c)})},l.update=function(a,b,c,d){if(this.__super__.__checkProjectId(a),!("undefined"!=typeof b&&null!==b||"undefined"!=typeof c&&null!==b))return!1;var e="project.update",f={};return b&&(f.name=b),"undefined"!=typeof c&&null!==c&&(f.description=c),this.__super__.sendRequest(e,f,function(a){var b=a.project;"function"==typeof d&&d(b)}),!0},l.delete=function(a,b){this.__super__.__checkProjectId(a);var c="project.delete";this.__super__.sendRequest(c,{project_id:a},function(){"function"==typeof b&&b(!0)})};var m={};m.new=function(a,b,c,d,e){this.__super__.__checkProjectId(a);var f="collection.new",g={name:b,project_id:a};"undefined"!=typeof d&&null!==d&&(g.description=d),"undefined"!=typeof c&&null!==c&&(g.key=c),this.__super__.__sendWithCallback(f,g,"collection",e)},m.get=function(a,b,c,d){this.__super__.__checkProjectId(a);var e="collection.get",f={project_id:a};("undefined"==typeof b||null===b)&&(f.status="all"),"undefined"!=typeof c&&null!==c&&(f.with_tags=c),this.__super__.__sendWithCallback(e,f,"collection",d)},m.getOne=function(a,b,c){this.__super__.__checkProjectId(a);var d="collection.get_one",e={project_id:a};e=this.__super__.__addCollectionIdentifier(e,b),this.__super__.__sendWithCallback(d,e,"collection",c)},m.activate=function(a,b,c,d){if(this.__super__.__checkProjectId(a),"number"!=typeof b)throw new Error("Collection.activate - collectionId must be a number");var e="collection.activate",f={project_id:a,collection_id:b};f.force="undefined"==typeof c||null===c?!1:c,this.__super__.__sendWithCallback(e,f,null,d)},m.deactivate=function(a,b,c){this.__super__.__checkProjectId(a);var d="collection.deactivate",e={project_id:a};e=this.__super__.__addCollectionIdentifier(e,b),this.__super__.__sendWithCallback(d,e,null,c)},m.update=function(a,b,c,d,e){this.__super__.__checkProjectId(a);var f="collection.update",g={project_id:a};g=this.__super__.__addCollectionIdentifier(g,b),"undefined"!=typeof c&&null!==c&&(g.name=c),"undefined"!=typeof d&&null!==d&&(g.name=d),this.__super__.__sendWithCallback(f,g,"collection",e)},m.addTag=function(a,b,c,d,e,f){this.__super__.__checkProjectId(a);var g="collection.add_tag",h={project_id:a};if(h=this.__super__.__addCollectionIdentifier(h,b),"string"!=typeof c&&("object"!=typeof c||"undefined"==typeof c.length))throw new Error("Collection.addTag - tags must be passed");var i;if(i="string"==typeof c?c:c.join(","),!/^[\000-\177]*$/.test(i))throw new Error("Collection.addTag - non ascii characters found in tag name");h.tags=c,h.weight=d||1,h.remove_other=!!e||!1,this.__super__.__sendWithCallback(g,h,null,f)},m.deleteTag=function(a,b,c,d){this.__super__.__checkProjectId(a);var e="collection.delete_tag",f={project_id:a};if(f=this.__super__.__addCollectionIdentifier(f,b),"string"!=typeof c&&("object"!=typeof c||"undefined"==typeof c.length))throw new Error("Collection.deleteTag - tags must be passed");var g;if(g="string"==typeof c?c:c.join(","),!/^[\000-\177]*$/.test(g))throw new Error("Collection.deleteTag - non ascii characters found in tag name");f.tags=c,this.__super__.__sendWithCallback(e,f,null,d)},m.delete=function(a,b,c){this.__super__.__checkProjectId(a);var d="collection.delete",e={project_id:a};e=this.__super__.__addCollectionIdentifier(e,b),this.__super__.__sendWithCallback(d,e,null,c)};var n={};n.new=function(a,b,c,d){if(this.__super__.__checkProjectId(a),!c)throw new Error("Folder must have a name");var e="folder.new",f={name:c,project_id:a};f=this.__super__.__addCollectionIdentifier(f,b),this.__super__.__sendWithCallback(e,f,"folder",d)},n.get=function(a,b,c){this.__super__.__checkProjectId(a);var d="folder.get",e={project_id:a};e=this.__super__.__addCollectionIdentifier(e,b),this.__super__.__sendWithCallback(d,e,"folder",c)},n.getOne=function(a,b,c,d){this.__super__.__checkProjectId(a);var e="folder.get_one",f={project_id:a};if(f=this.__super__.__addCollectionIdentifier(f,b),"string"!=typeof c)throw new Error("FolderName must be a string");f.folder_name=c,this.__super__.__sendWithCallback(e,f,"folder",d)},n.update=function(a,b,c,d,e,f){this.__super__.__checkProjectId(a);var g="folder.update",h={project_id:a};if(h=this.__super__.__addCollectionIdentifier(h,b),"string"!=typeof c)throw new Error("FolderName must be a string");if(h.name=c,"undefined"==typeof d||null===d)throw new Error("newName must be passed");if("string"!=typeof d)throw new Error("newName must be a string");h.new_name=d,null!==e&&(h.source_id=e+""),this.__super__.__sendWithCallback(g,h,"folder",f)},n.delete=function(a,b,c,d){this.__super__.__checkProjectId(a);var e="folder.delete",f={project_id:a};if(f=this.__super__.__addCollectionIdentifier(f,b),"string"!=typeof c)throw new Error("FolderName must be a string");f.name=c,this.__super__.__sendWithCallback(e,f,null,d)};var o={DISCONNECTED:1,CONNECTED:2,AUTHORIZED:3},p=function(){this.socketURL="https://api.hydraengine.com/ws",this.socket=null,this.status=o.DISCONNECTED,this.requestId=1,this.uuid=null,this.requestsQueue=[],this.waitingForResponse={},this.Project=l,this.Project.__super__=this,this.Collection=m,this.Collection.__super__=this,this.Folder=n,this.Folder.__super__=this};p.prototype=h(p.prototype,i),p.prototype.connect=function(b,c){if("undefined"==typeof b||"undefined"==typeof b.api_key||"undefined"==typeof b.instance)throw new Error("syncano.connect requires instance name and api_key");if("undefined"==typeof a.SockJS)throw new Error("SockJS is required");return this.connectionParams=b,this.status!=o.DISCONNECTED?void(this.reconnectOnSocketClose=!0):("function"==typeof c&&(this.waitingForResponse.auth=["auth",c]),this.socket=new a.SockJS(this.socketURL),this.socket.onopen=this.onSocketOpen.bind(this),this.socket.onclose=this.onSocketClose.bind(this),void(this.socket.onmessage=this.onMessage.bind(this)))},p.prototype.onSocketOpen=function(){this.status=o.CONNECTED,this.socketSend(this.connectionParams)},p.prototype.onSocketClose=function(){this.status=o.DISCONNECTED,this.socket=null,this.reconnectOnSocketClose===!0&&(this.reconnectOnSocketClose=!1,this.connect(this.connectionParams))},p.prototype.onMessage=function(a){var b=JSON.parse(a.data);if("NOK"===b.result)return this.trigger("syncano:error",b.data.error),void("auth"===b.type&&(this.socket.close(),this.trigger("syncano:auth:error")));switch(this.trigger("syncano:received",b),b.type){case"auth":this.parseAuthorizationResponse(b);break;case"callresponse":this.parseCallResponse(b)}},p.prototype.parseAuthorizationResponse=function(a){this.uuid=a.uuid,this.status=o.AUTHORIZED,this.trigger("syncano:authorized",this.uuid),this.parseCallResponse({message_id:"auth",data:a}),this.sendQueue()},p.prototype.parseCallResponse=function(a){var b=a.message_id;if("undefined"!=typeof b&&"undefined"!=typeof this.waitingForResponse[b]){var c=this.waitingForResponse[b],d=c[0].replace(".",":"),e=c[1];this.trigger("syncano:"+d,a.data),"function"==typeof e&&e(a.data),delete this.waitingForResponse[b]}else this.trigger("syncano:ignored",a)},p.prototype.sendQueue=function(){for(;this.requestsQueue.length>0;){var a=this.requestsQueue.shift();this.socketSend(a)}},p.prototype.getNextRequestId=function(){return this.requestId++},p.prototype.socketSend=function(a){this.socket.send(JSON.stringify(a)+"\n")},p.prototype.sendRequest=function(a,b,c){"undefined"==typeof b&&(b={});var d={type:"call",method:a,params:b};d.message_id=this.getNextRequestId(),this.waitingForResponse[d.message_id]=[a,c],this.status==o.AUTHORIZED?(this.trigger("syncano:call",d),this.socketSend(d)):(this.trigger("syncano:queued",d),this.requestsQueue.push(d))},p.prototype.__checkProjectId=function(a){if("number"!=typeof a)throw new Error("projectId must be a number")},p.prototype.__addCollectionIdentifier=function(a,b){if("string"==typeof b)a.collection_key=b;else{if("number"!=typeof b)throw new Error("Collection key/id must be passed");a.collection_id=b}return a},p.prototype.__sendWithCallback=function(a,b,c,d){this.sendRequest(a,b,function(a){var b;b=null===c?!0:a[c],"function"==typeof d&&d(b)})};var q=null;a.SyncanoConnector={getInstance:function(){return null===q&&(q=new p),q}}}(this);